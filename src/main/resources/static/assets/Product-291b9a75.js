import{D as _,S as v,P as y,p as c,i as w}from"./DeleteDialog-3c0c6c56.js";import C from"./ProductDetail-adf93b8c.js";import{_ as z,r as d,o as g,b as f,a,d as m,w as l,F as b,h as D,c as V,i as E,g as p,t as h}from"./index-ba8ae7a7.js";import{V as B,a as T,b as H}from"./VRow-c9acae30.js";import{V as L,a as N,b as k,c as I}from"./VCard-a98264cd.js";import"./api-9de8bbcf.js";import"./VDialog-493d3ece.js";const F={name:"Product",components:{DeleteDialog:_,SearchSort:v,ProductSave:y,ProductDetail:C},data(){return{newProduct:{name:"",description:"{}",price:0,image:""},loading:!1,products:[],page:1,pageSize:15,maxPageSize:1,sortBy:"",searchText:""}},mounted(){this.fetchProducts(),window.addEventListener("scroll",this.handleScroll)},beforeUnmount(){window.removeEventListener("scroll",this.handleScroll)},methods:{handleSubmit(){this.page=1,this.maxPageSize=1,this.products=[],this.fetchProducts()},handleSort(e){this.sortBy=e,this.page=1,this.maxPageSize=1,this.products=[],this.fetchProducts()},handleSearch(e){this.searchText=e},deleteProduct(e){c.deleteProduct(e).then(t=>{this.page=1,this.maxPageSize=1,this.products=[],this.fetchProducts()})},saveNewProduct(e,t){c.createProduct(e).then(n=>{this.page=1,this.maxPageSize=1,this.products=[],this.fetchProducts(),t.success(),window.alert("添加成功")})},saveProduct(e){console.log(e),c.updateProduct(e.id,e).then(t=>{this.page=1,this.maxPageSize=1,this.products=[],this.fetchProducts(),window.alert("修改成功")})},handleImageError(e){e.target.src="https://dummyimage.com/300x300/000/fff",console.log(e)},handleScroll(){const e=this.$refs.scrollContainer,t=e.scrollTop,n=e.clientHeight,r=e.scrollHeight;t+n-40>=r&&console.log("滚动到底部"),t+n+40>=r&&!this.loading&&this.page<=this.maxPageSize&&this.fetchProducts()},fetchProducts(e){this.loading=!0,c.getProductList({params:{page:this.page-1,size:this.pageSize,sortBy:this.sortBy,name:this.searchText}}).then(t=>{let n=t.data.content;this.products=[...this.products,...n],this.maxPageSize=t.data.totalPages,this.page===this.maxPageSize&&this.$refs.scrollContainer.removeEventListener("scroll",this.handleScroll),this.page+=1,this.loading=!1,this.products.forEach(r=>{let i=JSON.parse(r.description),o=document.createElement("div");o.innerHTML=(i.description!=="null"?i.description:"")+(i.ingredients?i.ingredients:""),r.detail=o.textContent,w.getImageByProductId(r.id).then(u=>{r.image="data:image/jpeg;base64,"+u.data.content})}),this.$refs.scrollContainer.scrollHeight<=this.$refs.scrollContainer.clientHeight&&this.page<=this.maxPageSize&&this.fetchProducts()})}}},R={style:{color:"red",float:"right"}},j={style:{"font-size":"small"}};function A(e,t,n,r,i,o){const u=d("SearchSort"),P=d("ProductDetail"),S=d("ProductSave"),x=d("DeleteDialog");return g(),f("div",null,[a(u,{style:{height:"60px"},loading:i.loading,onSearch:o.handleSearch,onSort:o.handleSort,onSubmit:o.handleSubmit},null,8,["loading","onSearch","onSort","onSubmit"]),m("div",{ref:"scrollContainer",style:{"overflow-y":"auto",height:"calc(100vh - 60px)"},onScroll:t[0]||(t[0]=(...s)=>o.handleScroll&&o.handleScroll(...s))},[a(B,null,{default:l(()=>[a(T,null,{default:l(()=>[(g(!0),f(b,null,D(i.products,s=>(g(),V(H,{key:s.id,cols:"12",sm:"6",md:"4",lg:"3"},{default:l(()=>[a(L,null,{default:l(()=>[a(E,{"aspect-ratio":"1.8",src:s.image,onError:o.handleImageError},null,8,["src","onError"]),a(N,null,{default:l(()=>[p(h(s.name),1),m("span",R,[p("￥"+h(s.price.toString().split(".")[0])+".",1),m("span",j,h(s.price.toString().split(".").length===2?s.price.toString().split(".")[1]:"00"),1)])]),_:2},1024),a(k,null,{default:l(()=>[p(h(s.detail),1)]),_:2},1024),a(I,{style:{display:"flex"}},{default:l(()=>[a(P,{product:s},null,8,["product"]),a(S,{product:s,edit:"",onSave:o.saveProduct},null,8,["product","onSave"]),a(x,{style:{right:"8px",position:"absolute"},id:s.id,onDelete:o.deleteProduct},null,8,["id","onDelete"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),a(S,{style:{position:"fixed",bottom:"20px",right:"10px"},product:i.newProduct,onSave:o.saveNewProduct},null,8,["product","onSave"])],544)])}const Q=z(F,[["render",A]]);export{Q as default};
